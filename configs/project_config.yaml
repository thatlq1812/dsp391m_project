# Traffic Forecasting Configuration v5.0
# Production configuration with real API only, improved caching, and distance filtering

project:
  name: traffic-forecast-production
  version: v5.0
  timezone: Asia/Ho_Chi_Minh
  bbox: [10.67, 106.60, 10.90, 106.84]

# Adaptive Collection Scheduler v5.1
# Cost-optimized: Balance between cost and data quality
# Target: ~$20/day (better than $28/day constant, with smarter collection)
scheduler:
  enabled: true
  mode: adaptive # Use 'fixed' for constant interval

  # Fixed interval mode (legacy - for testing only)
  fixed_interval_minutes: 60

  # Adaptive mode - balanced cost and quality
  adaptive:
    # Peak hours - High traffic variability (30 min intervals)
    # Capture rush hour patterns without excessive costs
    peak_hours:
      enabled: true
      time_ranges:
        # Morning rush (7-9 AM)
        - start: "07:00"
          end: "09:00"
        # Lunch rush (12-1 PM)
        - start: "12:00"
          end: "13:00"
        # Evening rush (5-8 PM)
        - start: "17:00"
          end: "20:00"
      interval_minutes: 30 # Every 30 min during peaks (not 15)

    # Off-peak hours - Moderate traffic (90 min intervals)
    # Less frequent but still adequate
    offpeak:
      enabled: true
      time_ranges:
        # Mid-morning (9 AM-12 PM)
        - start: "09:00"
          end: "12:00"
        # Afternoon (1-5 PM)
        - start: "13:00"
          end: "17:00"
        # Evening (8-11 PM)
        - start: "20:00"
          end: "23:00"
      interval_minutes: 90 # Every 90 min (1.5 hours)

    # Night hours - Stable traffic (skip completely)
    # Traffic very stable at night, skip to save costs
    night:
      enabled: true
      time_ranges:
        - start: "23:00"
          end: "07:00"
      interval_minutes: 240 # Placeholder (won't be used)
      skip: true # Skip night collection to save $

    # Weekend - Reduced schedule
    weekend:
      enabled: true
      use_offpeak_only: true
      interval_minutes: 120 # Every 2 hours on weekend

globals:
  area:
    mode: point_radius
    center: [106.697794, 10.772465]
    radius_m: 4096 # Expanded coverage area
    node_spacing_m: 500
  output_base: data_runs

# Node Selection Configuration v5.0
node_selection:
  min_degree: 3 # Changed from 6 - more realistic
  min_importance_score: 15.0 # Changed from 40 - better coverage
  max_nodes: 128 # Increased from 64
  min_distance_meters: 200 # NEW: Minimum distance between nodes
  road_type_filter:
    - motorway
    - trunk
    - primary
  require_street_names: true
  min_street_name_count: 2

data:
  parquet_dir: ./data/parquet
  json_dir: ./data
  cache_dir: ./cache

collectors:
  # Overpass - Static topology data v5.1
  # Cache permanently (topology doesn't change)
  overpass:
    enabled: true
    url: https://overpass-api.de/api/interpreter
    query_timeout: 120

    # Permanent caching (only fetch once)
    use_cache: true
    cache_expiry_days: 30 # Re-fetch monthly for safety
    cache_file: cache/overpass_topology.json
    force_cache: true # Never re-fetch if cache exists

    # Smart cache validation
    validate_cache:
      enabled: true
      min_nodes: 50 # Ensure cache has enough data
      required_fields: [id, lat, lon, tags]

    area:
      mode: point_radius
      center: [106.697794, 10.772465]
      radius_m: 4096

  # Open-Meteo Weather API v5.1
  # Optimized: Grid-based caching (1 call per 1km² instead of 78 calls)
  open_meteo:
    enabled: true
    base_url: https://api.open-meteo.com/v1/forecast
    current_params: [temperature_2m, precipitation, wind_speed_10m]
    forecast_params: [temperature_2m, precipitation, wind_speed_10m]
    horizons_min: [5, 15, 30, 60]

    # Smart caching strategy
    use_cache: true
    cache_expiry_minutes: 30 # Weather stable for 30min in same area
    cache_file: cache/weather_latest.json

    # Grid-based weather sharing (1km² cells)
    # Instead of 1 API call per node, use 1 call per grid cell
    grid_cache:
      enabled: true
      cell_size_meters: 1000 # 1km x 1km cells
      # Coverage area 4096m radius ≈ 16 cells (4x4 grid)
      # Reduces weather API calls by 95%!

    area:
      mode: point_radius
      center: [106.697794, 10.772465]
      radius_m: 4096

  # Google Directions API - REAL API ONLY (NO MOCK)
  google_directions:
    enabled: true
    api_key_env: GOOGLE_MAPS_API_KEY
    use_real_api_only: true # NEW: Force real API, no mock fallback
    rate_limit_requests_per_minute: 2800
    radius_km: 4.096 # Match radius_m = 4096m
    k_neighbors: 3
    limit_nodes: 128
    retry_on_failure: 3 # NEW: Retry failed requests
    timeout_seconds: 10
    area:
      mode: point_radius
      center: [106.697794, 10.772465]
      radius_m: 4096

api:
  title: Traffic Forecast API
  description: API serving node-level traffic forecasts
  predictions_file: data/predictions.json
  port: 8000

pipelines:
  preprocess:
    features_file: data/features_nodes_v2.json
    output_dir: data/processed
    target_column: avg_speed_kmh

    feature_columns:
      # Current traffic
      - avg_speed_kmh
      - congestion_level

      # Current weather
      - temperature_c
      - rain_mm
      - wind_speed_kmh

      # Weather forecasts
      - forecast_temp_t5_c
      - forecast_temp_t15_c
      - forecast_temp_t30_c
      - forecast_temp_t60_c
      - forecast_rain_t5_mm
      - forecast_rain_t15_mm
      - forecast_rain_t30_mm
      - forecast_rain_t60_mm
      - forecast_wind_t5_kmh
      - forecast_wind_t15_kmh
      - forecast_wind_t30_kmh
      - forecast_wind_t60_kmh

      # Traffic lag features
      - speed_lag_5min
      - speed_lag_15min
      - speed_lag_30min
      - speed_lag_60min
      - congestion_lag_5min
      - congestion_lag_15min
      - congestion_lag_30min
      - congestion_lag_60min

    outlier_std_multiplier: 3

  training:
    test_size: 0.2
    val_size: 0.1
    random_state: 42
    cv_folds: 5 # NEW: Cross-validation folds

models:
  xgboost:
    n_estimators: 100
    max_depth: 6
    learning_rate: 0.1
    random_state: 42

  random_forest:
    n_estimators: 100
    max_depth: 10
    random_state: 42

  lightgbm:
    n_estimators: 100
    max_depth: 6
    learning_rate: 0.1
    random_state: 42

visualization:
  enabled: true
  save_plots: true
  output_dir: data/plots
  plot_types:
    - feature_importance
    - residuals
    - predictions_vs_actual
    - time_series
    - distributions
    - correlations

traffic_history:
  enabled: true
  db_path: data/traffic_history.db
  retention_days: 30
  lag_minutes: [5, 15, 30, 60]
